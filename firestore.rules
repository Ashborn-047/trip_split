rules_version = '2';

/**
 * TripSplit - Firestore Security Rules
 * 
 * SECURITY MODEL:
 * - Users can only access trips they are members of
 * - Trip admins have additional privileges
 * - Ghost members can be added by admins only
 * 
 * STRUCTURE:
 * /trips/{tripId}
 *   /members/{memberId}
 *   /expenses/{expenseId}
 *     /splits/{splitId}
 */

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper: Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper: Get user ID
    function userId() {
      return request.auth.uid;
    }
    
    // Helper: Check if user is a member of the trip (doc ID check)
    function isTripMember(tripId) {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/trips/$(tripId)/members/$(userId()));
    }
    
    // Helper: Get member data
    function getMemberData(tripId, memberId) {
      return get(/databases/$(database)/documents/trips/$(tripId)/members/$(memberId)).data;
    }
    
    // Helper: Check if user is admin
    function isAdmin(tripId) {
      return isAuthenticated() && getMemberData(tripId, userId()).role == 'admin';
    }

    // =====================
    // TRIPS COLLECTION
    // =====================
    match /trips/{tripId} {
      // Must be a member to read trip metadata
      allow read: if isTripMember(tripId);
      
      // Anyone authenticated can create
      allow create: if isAuthenticated() && request.resource.data.created_by == userId();
      
      // Only admin can update trip metadata (name, currency)
      allow update: if isAdmin(tripId);
      
      // Only admin can delete trip
      allow delete: if isAdmin(tripId);
      
      // =====================
      // MEMBERS SUBCOLLECTION
      // =====================
      match /members/{memberId} {
        // Members read fellow members
        allow read: if isTripMember(tripId);
        
        // Joining: user_id must match auth.uid OR Admin adds ghost
        allow create: if isAuthenticated() && (
          request.resource.data.user_id == userId() || 
          (isAdmin(tripId) && request.resource.data.role == 'ghost')
        );

        // Only self can update display_name; Admin can update role
        allow update: if isAuthenticated() && (
          (request.auth.uid == memberId && request.resource.data.role == resource.data.role) ||
          isAdmin(tripId)
        );

        // Only admin can remove members
        allow delete: if isAdmin(tripId);
      }
      
      // =====================
      // EXPENSES SUBCOLLECTION
      // =====================
      match /expenses/{expenseId} {
        allow read: if isTripMember(tripId);
        
        // Must be member & created_by must match self
        allow create: if isTripMember(tripId) && 
          request.resource.data.created_by == userId();
          
        // Only creator can update
        allow update: if isTripMember(tripId) && 
          resource.data.created_by == userId();
        
        // Only creator or admin can delete
        allow delete: if isTripMember(tripId) && (
          resource.data.created_by == userId() || isAdmin(tripId)
        );
        
        // =====================
        // SPLITS SUBCOLLECTION
        // =====================
        match /splits/{splitId} {
          allow read: if isTripMember(tripId);
          
          // Managed as part of expense batch - same creator check
          allow write: if isTripMember(tripId) && (
            get(/databases/$(database)/documents/trips/$(tripId)/expenses/$(expenseId)).data.created_by == userId()
          );
        }
      }
    }
    
    // =====================
    // HEALTH CHECK
    // =====================
    match /health_check/status {
      allow read: if true;
      allow write: if false; // Managed via console or admin
    }

    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
