name: Firebase Health Check

on:
  schedule:
    # Run every 12 hours to monitor database health
    - cron: '0 */12 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  health-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Firebase Admin
        run: npm install firebase

      - name: Run Health Check
        id: health
        env:
          FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
        run: |
          node -e "
          const firebase = require('firebase/compat/app');
          require('firebase/compat/firestore');
          const fs = require('fs');
          
          async function healthCheck() {
            try {
              const app = firebase.default.initializeApp({
                apiKey: process.env.FIREBASE_API_KEY,
                projectId: process.env.FIREBASE_PROJECT_ID,
              });
              
              const db = app.firestore();
              const start = Date.now();
              
              // Simple query to ping the database
              await db.collection('trips').limit(1).get();
              
              const latency = Date.now() - start;
              console.log('STATUS=healthy');
              console.log('LATENCY=' + latency + 'ms');
              
              // Write to GitHub Output
              if (process.env.GITHUB_OUTPUT) {
                fs.appendFileSync(process.env.GITHUB_OUTPUT, 'latency=' + latency + 'ms\n');
              }
            } catch (error) {
              console.log('STATUS=unhealthy');
              console.log('ERROR=' + error.message);
              if (process.env.GITHUB_OUTPUT) {
                fs.appendFileSync(process.env.GITHUB_OUTPUT, 'error_msg=' + error.message + '\n');
              }
              process.exit(1);
            }
          }
          
          healthCheck();
          "

      - name: Send Discord Notification (Success)
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          LATENCY: ${{ steps.health.outputs.latency }}
        run: |
          curl -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "üõ°Ô∏è TripSplit System Pulse",
                "description": "The Firebase Infrastructure is **fully operational** and responding with optimal performance.",
                "color": 3066993,
                "fields": [
                  {"name": "üì° Status", "value": "`Online`", "inline": true},
                  {"name": "‚ö° Latency", "value": "`'"$LATENCY"'`", "inline": true},
                  {"name": "üìÅ Project", "value": "trip-split-v1", "inline": true}
                ],
                "footer": {
                  "text": "Automated Pulse ‚Ä¢ Next check in 12 hours",
                  "icon_url": "https://cdn-icons-png.flaticon.com/512/3119/3119338.png"
                },
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }]
            }' \
            $DISCORD_WEBHOOK

      - name: Send Discord Notification (Failure)
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          ERROR_MSG: ${{ steps.health.outputs.error_msg }}
        run: |
          curl -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "üö® CRITICAL: Database Offline",
                "description": "Emergency alert! The TripSplit database failed its health check. Immediate investigation required.",
                "color": 15158332,
                "fields": [
                  {"name": "‚ùå Error Type", "value": "Firestore Connection Timeout", "inline": true},
                  {"name": "‚ö†Ô∏è Message", "value": "`'"${ERROR_MSG:-Unknown Error}"'`", "inline": false}
                ],
                "footer": {
                  "text": "System Alert ‚Ä¢ Manual intervention needed",
                  "icon_url": "https://cdn-icons-png.flaticon.com/512/564/564619.png"
                },
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }]
            }' \
            $DISCORD_WEBHOOK
